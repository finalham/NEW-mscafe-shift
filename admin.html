<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mscafe SHIFT | 管理</title>
<style>
  :root{ --ink:#222; --muted:#6b7280; --line:#e5e7eb; --bg:#fafafa; --card:#fff; --pri:#2563eb; --pri-ink:#fff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(10px);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center}
  header h1{font-size:16px;margin:0 6px 0 0}
  main{max-width:980px;margin:16px auto;padding:0 12px}
  nav{display:flex;gap:8px;margin-left:auto}
  nav a{padding:8px 12px;border:1px solid var(--line);border-radius:999px;text-decoration:none;color:var(--muted);background:#fff}
  nav a.active{background:var(--pri);border-color:var(--pri);color:var(--pri-ink);font-weight:600}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.03)}
  label{font-size:12px;color:var(--muted)}
  input,select,button{font:inherit}
  input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center}
  .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .grid{display:grid;grid-template-columns:1fr 160px 120px 120px 120px;gap:6px}
  .grid .h{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid var(--line);padding:8px 10px}
  thead th{background:#f9fafb;position:sticky;top:0}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .hidden{display:none}
  @media (max-width:680px){
    .grid{grid-template-columns:1fr 120px 96px 96px 110px}
    header{flex-wrap:wrap}
    nav{width:100%;justify-content:flex-end}
  }
</style>

<header>
  <h1>☕ Mscafe SHIFT | 管理</h1>
  <div class="row" style="gap:6px">
    <label>対象月</label>
    <input type="month" id="month" style="min-width:160px">
    <button class="btn" id="btnRefresh">🔄 更新</button>
    <button class="btn" id="btnCsvAll">📥 CSV（全体）</button>
  </div>
  <nav>
    <a href="#list" id="tabList">月次一覧</a>
    <a href="#emp" id="tabEmp">従業員</a>
  </nav>
</header>

<main>
  <!-- 月次一覧 -->
  <section id="viewList" class="card">
    <div id="listArea">
      <div class="grid" style="margin-bottom:6px">
        <div class="h">氏名</div>
        <div class="h right">勤務日数</div>
        <div class="h right">総時間(h)</div>
        <div class="h right">基本支給</div>
        <div class="h right">総支給</div>
      </div>
      <div id="listRows"></div>
      <div id="drill" class="hidden" style="margin-top:10px">
        <div class="row" style="justify-content:space-between">
          <strong id="drillTitle"></strong>
          <div class="row" style="gap:6px">
            <button class="btn" id="btnBack">← 一覧へ</button>
            <button class="btn" id="btnCsvOne">📥 CSV（この人）</button>
          </div>
        </div>
        <div class="card" style="padding:0;margin-top:8px">
          <table id="detailTable">
            <thead><tr>
              <th>日付</th><th>出勤</th><th>退勤</th>
              <th class="right">休憩(分)</th>
              <th class="right">実働(h)</th>
              <th class="right">時給</th>
              <th class="right">日給額</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- 従業員 -->
  <section id="viewEmp" class="card hidden">
    <div class="grid" style="margin-bottom:6px">
      <div class="h">氏名</div>
      <div class="h">社員番号</div>
      <div class="h right">時給</div>
      <div class="h right">交通費</div>
      <div class="h">状態/保存</div>
    </div>
    <div id="empRows"></div>
    <p class="muted" style="margin-top:8px">※「保存」を押すと時給・交通費・有効/無効を更新します</p>
  </section>
</main>

<script>
const API_B = 'https://script.google.com/macros/s/AKfycbyXku_YsY0Yh8hZvDSwlp0ilu3ZLLXsamvwDTYnLt5LrAMgYQYWMAa-xABFi8vRXv-w/exec'; // ← 置換済み

/* -------------- 小ユーティリティ -------------- */
const $ = (sel, root=document)=>root.querySelector(sel);
function pad(n){ return String(n).padStart(2,'0') }
function hm(iso){
  const d = new Date(iso); if (isNaN(d)) return '';
  return pad(d.getHours())+':'+pad(d.getMinutes());
}
function money(n){ return (Number(n)||0).toLocaleString() }
function hours(min){ return (Number(min||0)/60).toFixed(2) }

/* -------------- タブ切替 -------------- */
function route(){
  const hash = location.hash || '#list';
  $('#tabList').classList.toggle('active', hash==='#list');
  $('#tabEmp').classList.toggle('active',  hash==='#emp');
  $('#viewList').classList.toggle('hidden', hash!=='#list');
  $('#viewEmp').classList.toggle('hidden',  hash!=='#emp');
}
window.addEventListener('hashchange', route);

/* -------------- API -------------- */
async function apiGet(params){
  const url = API_B + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET' });
  return res.headers.get('content-type')?.includes('application/json') ? res.json() : {ok:false,error:'not json'};
}
async function apiPost(action, body){
  const res = await fetch(API_B, {
    method:'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({...body, action})
  });
  return res.json().catch(()=>({ok:false,error:'json parse'}));
}

/* -------------- 月次一覧 -------------- */
let currentMonth = '';
let drillEmp = null;

async function loadSummary(){
  const month = $('#month').value;
  currentMonth = month;
  const {ok, rows, error} = await apiGet({action:'summary', month});
  if(!ok) { $('#listRows').innerHTML = `<div class="muted">Error: ${error||'failed'}</div>`; return; }

  // 一覧
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'grid';
    div.innerHTML =
      `<div><button class="btn" data-id="${r.employee_id}" style="padding:6px 10px">${r.employee_name}</button></div>
       <div class="right">${r.days}</div>
       <div class="right">${r.hours}</div>
       <div class="right">${money(r.base_pay)}</div>
       <div class="right">${money(r.total_pay)}</div>`;
    frag.appendChild(div);
  });
  $('#listRows').innerHTML = '';
  $('#listRows').appendChild(frag);

  // ドリルダウンリスナー
  $('#listRows').querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick = ()=> showDetail(b.getAttribute('data-id'), b.textContent);
  });

  // 明細を閉じる
  $('#drill').classList.add('hidden');
}

async function showDetail(empId, empName){
  drillEmp = {id:empId, name:empName};
  $('#drillTitle').textContent = `${empName} の明細（${currentMonth}）`;
  const {ok, rows, error} = await apiGet({action:'shifts', month:currentMonth, employee_id:empId});
  if(!ok){ $('#detailTable tbody').innerHTML = `<tr><td colspan="7" class="muted">Error: ${error||'failed'}</td></tr>`; return; }

  const tb = $('#detailTable tbody');
  tb.innerHTML = '';
  rows.sort((a,b)=> a.date.localeCompare(b.date)).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${hm(r.start)}</td>
      <td>${hm(r.end)}</td>
      <td class="right">${r.break_min}</td>
      <td class="right">${hours(r.worked_min)}</td>
      <td class="right">${money(r.hourly_wage)}</td>
      <td class="right">${money(r.daily_pay)}</td>
    `;
    tb.appendChild(tr);
  });

  $('#drill').classList.remove('hidden');
}

$('#btnBack').onclick = ()=>{ $('#drill').classList.add('hidden'); drillEmp=null; };
$('#btnRefresh').onclick = loadSummary;
$('#btnCsvAll').onclick = ()=>{
  if(!currentMonth) return;
  const url = API_B + '?' + new URLSearchParams({action:'report_csv', month:currentMonth}).toString();
  window.open(url, '_blank');
};
$('#btnCsvOne').onclick = ()=>{
  if(!currentMonth || !drillEmp) return;
  const url = API_B + '?' + new URLSearchParams({action:'report_csv', month:currentMonth, employee_id:drillEmp.id}).toString();
  window.open(url, '_blank');
};

/* -------------- 従業員 -------------- */
async function loadEmployees(){
  const {ok, employees, error} = await apiGet({action:'employees_full'});
  if(!ok){ $('#empRows').innerHTML = `<div class="muted">Error: ${error||'failed'}</div>`; return; }

  const frag = document.createDocumentFragment();
  employees.forEach(e=>{
    const row = document.createElement('div');
    row.className = 'grid';
    row.innerHTML = `
      <div><input value="${e.name}" data-k="name"></div>
      <div><input value="${e.code||''}" data-k="code"></div>
      <div><input class="right" type="number" value="${e.hourly_wage||0}" data-k="hourly_wage"></div>
      <div><input class="right" type="number" value="${e.commute_fixed||0}" data-k="commute_fixed"></div>
      <div class="row" style="gap:6px">
        <select data-k="active"><option value="true"${e.active?' selected':''}>有効</option><option value="false"${!e.active?' selected':''}>無効</option></select>
        <button class="btn primary" data-id="${e.id}">保存</button>
      </div>`;
    row.dataset.id = e.id;
    frag.appendChild(row);
  });
  $('#empRows').innerHTML = '';
  $('#empRows').appendChild(frag);

  $('#empRows').querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = async ()=>{
      const row = btn.closest('.grid');
      const id = row.dataset.id;
      const get = k => row.querySelector(`[data-k="${k}"]`).value;
      const payload = {
        id,
        name: get('name'),
        code: get('code'),
        hourly_wage: Number(get('hourly_wage')||0),
        commute_fixed: Number(get('commute_fixed')||0),
        active: (row.querySelector('[data-k="active"]').value === 'true')
      };
      const res = await apiPost('employee_update', payload);
      if(res.ok){ btn.textContent='保存済'; setTimeout(()=>btn.textContent='保存',1000); }
      else { alert('更新失敗: '+(res.error||'')); }
    };
  });
}

/* -------------- 起動 -------------- */
(function init(){
  // 月の初期値
  const now = new Date();
  $('#month').value = now.getFullYear() + '-' + pad(now.getMonth()+1);

  route();
  if (location.hash==='#emp'){ loadEmployees(); }
  else { loadSummary(); }

  $('#tabList').onclick = (e)=>{ e.preventDefault(); location.hash='#list'; loadSummary(); };
  $('#tabEmp').onclick  = (e)=>{ e.preventDefault(); location.hash='#emp';  loadEmployees(); };
})();
</script>
