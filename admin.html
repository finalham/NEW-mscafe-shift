<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mscafe SHIFT | ç®¡ç†</title>
<style>
  :root{ --ink:#222; --muted:#6b7280; --line:#e5e7eb; --bg:#fafafa; --card:#fff; --pri:#2563eb; --pri-ink:#fff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(10px);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center}
  header h1{font-size:16px;margin:0 6px 0 0}
  main{max-width:980px;margin:16px auto;padding:0 12px}
  nav{display:flex;gap:8px;margin-left:auto}
  nav a{padding:8px 12px;border:1px solid var(--line);border-radius:999px;text-decoration:none;color:var(--muted);background:#fff}
  nav a.active{background:var(--pri);border-color:var(--pri);color:var(--pri-ink);font-weight:600}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.03)}
  label{font-size:12px;color:var(--muted)}
  input,select,button{font:inherit}
  input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center}
  .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .grid{display:grid;grid-template-columns:1fr 160px 120px 120px 120px;gap:6px}
  .grid .h{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid var(--line);padding:8px 10px}
  thead th{background:#f9fafb;position:sticky;top:0}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .hidden{display:none}
  @media (max-width:680px){
    .grid{grid-template-columns:1fr 120px 96px 96px 110px}
    header{flex-wrap:wrap}
    nav{width:100%;justify-content:flex-end}
  }
</style>

<header>
  <h1>â˜• Mscafe SHIFT | ç®¡ç†</h1>
  <div class="row" style="gap:6px">
    <label>å¯¾è±¡æœˆ</label>
    <input type="month" id="month" style="min-width:160px">
    <button class="btn" id="btnRefresh">ğŸ”„ æ›´æ–°</button>
    <button class="btn" id="btnCsvAll">ğŸ“¥ CSVï¼ˆå…¨ä½“ï¼‰</button>
  </div>
  <nav>
    <a href="#list" id="tabList">æœˆæ¬¡ä¸€è¦§</a>
    <a href="#emp" id="tabEmp">å¾“æ¥­å“¡</a>
  </nav>
</header>

<main>
  <!-- æœˆæ¬¡ä¸€è¦§ -->
  <section id="viewList" class="card">
    <div id="listArea">
      <div class="grid" style="margin-bottom:6px">
        <div class="h">æ°å</div>
        <div class="h right">å‹¤å‹™æ—¥æ•°</div>
        <div class="h right">ç·æ™‚é–“(h)</div>
        <div class="h right">åŸºæœ¬æ”¯çµ¦</div>
        <div class="h right">ç·æ”¯çµ¦</div>
      </div>
      <div id="listRows"></div>
      <div id="drill" class="hidden" style="margin-top:10px">
        <div class="row" style="justify-content:space-between">
          <strong id="drillTitle"></strong>
          <div class="row" style="gap:6px">
            <button class="btn" id="btnBack">â† ä¸€è¦§ã¸</button>
            <button class="btn" id="btnCsvOne">ğŸ“¥ CSVï¼ˆã“ã®äººï¼‰</button>
          </div>
        </div>
        <div class="card" style="padding:0;margin-top:8px">
          <table id="detailTable">
            <thead><tr>
              <th>æ—¥ä»˜</th><th>å‡ºå‹¤</th><th>é€€å‹¤</th>
              <th class="right">ä¼‘æ†©(åˆ†)</th>
              <th class="right">å®Ÿåƒ(h)</th>
              <th class="right">æ™‚çµ¦</th>
              <th class="right">æ—¥çµ¦é¡</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- å¾“æ¥­å“¡ -->
  <section id="viewEmp" class="card hidden">
    <div class="grid" style="margin-bottom:6px">
      <div class="h">æ°å</div>
      <div class="h">ç¤¾å“¡ç•ªå·</div>
      <div class="h right">æ™‚çµ¦</div>
      <div class="h right">äº¤é€šè²»</div>
      <div class="h">çŠ¶æ…‹/ä¿å­˜</div>
    </div>
    <div id="empRows"></div>
    <p class="muted" style="margin-top:8px">â€»ã€Œä¿å­˜ã€ã‚’æŠ¼ã™ã¨æ™‚çµ¦ãƒ»äº¤é€šè²»ãƒ»æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°ã—ã¾ã™</p>
  </section>
</main>

<script>
const API_B = 'https://script.google.com/macros/s/AKfycbyXku_YsY0Yh8hZvDSwlp0ilu3ZLLXsamvwDTYnLt5LrAMgYQYWMAa-xABFi8vRXv-w/exec'; // â† ç½®æ›æ¸ˆã¿

/* -------------- å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -------------- */
const $ = (sel, root=document)=>root.querySelector(sel);
function pad(n){ return String(n).padStart(2,'0') }
function hm(iso){
  const d = new Date(iso); if (isNaN(d)) return '';
  return pad(d.getHours())+':'+pad(d.getMinutes());
}
function money(n){ return (Number(n)||0).toLocaleString() }
function hours(min){ return (Number(min||0)/60).toFixed(2) }

/* -------------- ã‚¿ãƒ–åˆ‡æ›¿ -------------- */
function route(){
  const hash = location.hash || '#list';
  $('#tabList').classList.toggle('active', hash==='#list');
  $('#tabEmp').classList.toggle('active',  hash==='#emp');
  $('#viewList').classList.toggle('hidden', hash!=='#list');
  $('#viewEmp').classList.toggle('hidden',  hash!=='#emp');
}
window.addEventListener('hashchange', route);

/* -------------- API -------------- */
async function apiGet(params){
  const url = API_B + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET' });
  return res.headers.get('content-type')?.includes('application/json') ? res.json() : {ok:false,error:'not json'};
}
async function apiPost(action, body){
  const res = await fetch(API_B, {
    method:'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({...body, action})
  });
  return res.json().catch(()=>({ok:false,error:'json parse'}));
}

/* -------------- æœˆæ¬¡ä¸€è¦§ -------------- */
let currentMonth = '';
let drillEmp = null;

async function loadSummary(){
  const month = $('#month').value;
  currentMonth = month;
  const {ok, rows, error} = await apiGet({action:'summary', month});
  if(!ok) { $('#listRows').innerHTML = `<div class="muted">Error: ${error||'failed'}</div>`; return; }

  // ä¸€è¦§
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'grid';
    div.innerHTML =
      `<div><button class="btn" data-id="${r.employee_id}" style="padding:6px 10px">${r.employee_name}</button></div>
       <div class="right">${r.days}</div>
       <div class="right">${r.hours}</div>
       <div class="right">${money(r.base_pay)}</div>
       <div class="right">${money(r.total_pay)}</div>`;
    frag.appendChild(div);
  });
  $('#listRows').innerHTML = '';
  $('#listRows').appendChild(frag);

  // ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒŠãƒ¼
  $('#listRows').querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick = ()=> showDetail(b.getAttribute('data-id'), b.textContent);
  });

  // æ˜ç´°ã‚’é–‰ã˜ã‚‹
  $('#drill').classList.add('hidden');
}

async function showDetail(empId, empName){
  drillEmp = {id:empId, name:empName};
  $('#drillTitle').textContent = `${empName} ã®æ˜ç´°ï¼ˆ${currentMonth}ï¼‰`;
  const {ok, rows, error} = await apiGet({action:'shifts', month:currentMonth, employee_id:empId});
  if(!ok){ $('#detailTable tbody').innerHTML = `<tr><td colspan="7" class="muted">Error: ${error||'failed'}</td></tr>`; return; }

  const tb = $('#detailTable tbody');
  tb.innerHTML = '';
  rows.sort((a,b)=> a.date.localeCompare(b.date)).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${hm(r.start)}</td>
      <td>${hm(r.end)}</td>
      <td class="right">${r.break_min}</td>
      <td class="right">${hours(r.worked_min)}</td>
      <td class="right">${money(r.hourly_wage)}</td>
      <td class="right">${money(r.daily_pay)}</td>
    `;
    tb.appendChild(tr);
  });

  $('#drill').classList.remove('hidden');
}

$('#btnBack').onclick = ()=>{ $('#drill').classList.add('hidden'); drillEmp=null; };
$('#btnRefresh').onclick = loadSummary;
$('#btnCsvAll').onclick = ()=>{
  if(!currentMonth) return;
  const url = API_B + '?' + new URLSearchParams({action:'report_csv', month:currentMonth}).toString();
  window.open(url, '_blank');
};
$('#btnCsvOne').onclick = ()=>{
  if(!currentMonth || !drillEmp) return;
  const url = API_B + '?' + new URLSearchParams({action:'report_csv', month:currentMonth, employee_id:drillEmp.id}).toString();
  window.open(url, '_blank');
};

/* -------------- å¾“æ¥­å“¡ -------------- */
async function loadEmployees(){
  const {ok, employees, error} = await apiGet({action:'employees_full'});
  if(!ok){ $('#empRows').innerHTML = `<div class="muted">Error: ${error||'failed'}</div>`; return; }

  const frag = document.createDocumentFragment();
  employees.forEach(e=>{
    const row = document.createElement('div');
    row.className = 'grid';
    row.innerHTML = `
      <div><input value="${e.name}" data-k="name"></div>
      <div><input value="${e.code||''}" data-k="code"></div>
      <div><input class="right" type="number" value="${e.hourly_wage||0}" data-k="hourly_wage"></div>
      <div><input class="right" type="number" value="${e.commute_fixed||0}" data-k="commute_fixed"></div>
      <div class="row" style="gap:6px">
        <select data-k="active"><option value="true"${e.active?' selected':''}>æœ‰åŠ¹</option><option value="false"${!e.active?' selected':''}>ç„¡åŠ¹</option></select>
        <button class="btn primary" data-id="${e.id}">ä¿å­˜</button>
      </div>`;
    row.dataset.id = e.id;
    frag.appendChild(row);
  });
  $('#empRows').innerHTML = '';
  $('#empRows').appendChild(frag);

  $('#empRows').querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = async ()=>{
      const row = btn.closest('.grid');
      const id = row.dataset.id;
      const get = k => row.querySelector(`[data-k="${k}"]`).value;
      const payload = {
        id,
        name: get('name'),
        code: get('code'),
        hourly_wage: Number(get('hourly_wage')||0),
        commute_fixed: Number(get('commute_fixed')||0),
        active: (row.querySelector('[data-k="active"]').value === 'true')
      };
      const res = await apiPost('employee_update', payload);
      if(res.ok){ btn.textContent='ä¿å­˜æ¸ˆ'; setTimeout(()=>btn.textContent='ä¿å­˜',1000); }
      else { alert('æ›´æ–°å¤±æ•—: '+(res.error||'')); }
    };
  });
}

/* -------------- èµ·å‹• -------------- */
(function init(){
  // æœˆã®åˆæœŸå€¤
  const now = new Date();
  $('#month').value = now.getFullYear() + '-' + pad(now.getMonth()+1);

  route();
  if (location.hash==='#emp'){ loadEmployees(); }
  else { loadSummary(); }

  $('#tabList').onclick = (e)=>{ e.preventDefault(); location.hash='#list'; loadSummary(); };
  $('#tabEmp').onclick  = (e)=>{ e.preventDefault(); location.hash='#emp';  loadEmployees(); };
})();
</script>
