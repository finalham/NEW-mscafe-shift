<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mscafe SHIFT | 管理</title>
<style>
  :root{--bg:#fafafa;--ink:#222;--muted:#666;--brand:#2e7d6b;--warn:#b3261e;--line:#e7e7e7}
  *{box-sizing:border-box} body{margin:0;font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;font-weight:700;color:var(--brand)}
  main{max-width:960px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px 14px 18px;margin:12px 0;box-shadow:0 4px 14px rgba(0,0,0,.03)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
  input,select,button{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
  input:focus,select:focus{outline:2px solid rgba(46,125,107,.15);border-color:var(--brand)}
  .btn{cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.ghost{background:#fff;color:var(--brand)}
  .btn.warn{background:#fff;color:var(--warn);border-color:#f1c9c9}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid var(--line);padding:8px} thead th{background:#f7f7f7}
  @media(min-width:760px){ .grid{grid-template-columns:repeat(3,1fr)} }
</style>
</head>
<body>
<header>管理・給与ルール</header>
<main>
  <!-- 従業員管理 -->
  <div class="card">
    <h3 style="margin:0 0 8px">従業員（時給・交通費）</h3>
    <div class="grid">
      <div><label>氏名</label><input id="emp_name"></div>
      <div><label>社員番号</label><input id="emp_code"></div>
      <div><label>時給（円）</label><input id="emp_wage" type="number" inputmode="numeric" min="0"></div>
      <div><label>交通費（月額・定額／円）</label><input id="emp_commute" type="number" inputmode="numeric" min="0" value="0"></div>
    </div>
    <div class="grid" style="margin-top:12px">
      <button id="btnAdd" class="btn primary">➕ 追加/更新</button>
      <button id="btnReloadEmp" class="btn ghost">🔄 再読込</button>
      <div></div>
    </div>
    <table id="empTable" style="margin-top:12px">
      <thead><tr><th>状態</th><th>氏名</th><th>番号</th><th style="text-align:right">時給</th><th style="text-align:right">交通費</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="muted" id="empMsg" style="margin-top:8px"></p>
  </div>

  <!-- 給与ルール（共通） -->
  <div class="card">
    <h3 style="margin:0 0 8px">給与ルール（共通）</h3>
    <div class="grid">
      <div><label>開始丸め（分）</label><input id="r_start" type="number" min="1" value="5"></div>
      <div><label>終了丸め（分）</label><input id="r_end" type="number" min="1" value="5"></div>
      <div><label>実働丸め（分）</label><input id="r_worked" type="number" min="1" value="1"></div>
      <div><label>丸め方式</label>
        <select id="r_mode">
          <option value="floor">切捨て</option>
          <option value="round">四捨五入</option>
          <option value="ceil">切上げ</option>
        </select>
      </div>
      <div><label>時給デフォルト（円）</label><input id="r_wage" type="number" min="0" value="1100"></div>
    </div>
    <div class="grid" style="margin-top:12px">
      <button id="btnSaveRules" class="btn primary">💾 ルール保存</button>
      <button id="btnReloadRules" class="btn ghost">🔄 再読込</button>
      <div></div>
    </div>
    <p class="muted" id="ruleMsg" style="margin-top:8px"></p>
  </div>

  <!-- 月次CSV -->
  <div class="card">
    <h3 style="margin:0 0 8px">月次レポート（CSV）</h3>
    <div class="grid">
      <div><label>対象月</label><input id="csvMonth" type="month"></div>
      <button id="btnCSV" class="btn primary">⬇ ダウンロード</button>
      <div></div>
    </div>
  </div>
</main>

<script>
/* API B（必要なら差し替えてください） */
const API_B = 'https://script.google.com/macros/s/AKfycbxdAZGMCSF9rsAwgkQgfhHC9Ijrb80Lox0FfWRSVtIncEbEj2ATbSZy6cHVxRSGnvjg/exec';

async function getJSON(url){ const r=await fetch(url,{credentials:"omit",cache:"no-store"}); return await r.json(); }
async function postJSON(url, obj){ const r=await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(obj)}); return await r.json(); }
function yen(n){ return (Number(n)||0).toLocaleString() }

async function loadEmployees(){
  const data = await getJSON(API_B+'?action=employees_full');
  const tb = document.querySelector('#empTable tbody'); tb.innerHTML='';
  (data.employees||[]).forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.active? '有効':'無効'}</td>
      <td>${e.name}</td>
      <td>${e.code||''}</td>
      <td style="text-align:right">${yen(e.hourly_wage)}</td>
      <td style="text-align:right">${yen(e.commute_fixed)}</td>
      <td>
        <button class="btn ghost" data-act="edit" data-id="${e.id}" data-name="${e.name}" data-code="${e.code||''}" data-wage="${e.hourly_wage||0}" data-commute="${e.commute_fixed||0}">編集</button>
        <button class="btn ${e.active?'warn':'ghost'}" data-act="toggle" data-id="${e.id}">${e.active?'無効化':'有効化'}</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>{
    b.onclick = async ()=>{
      const act = b.dataset.act, id = b.dataset.id;
      if(act==='toggle'){
        const res = await postJSON(API_B+'?action=employee_toggle',{id});
        document.getElementById('empMsg').textContent = res.ok? '状態を更新しました':'エラー：'+(res.error||'');
        loadEmployees();
      }else if(act==='edit'){
        document.getElementById('emp_name').value = b.dataset.name;
        document.getElementById('emp_code').value = b.dataset.code||'';
        document.getElementById('emp_wage').value = b.dataset.wage||'';
        document.getElementById('emp_commute').value = b.dataset.commute||'0';
        document.getElementById('btnAdd').dataset.editId = id; // 更新モード
        window.scrollTo({top:0,behavior:'smooth'});
      }
    };
  });
}

async function upsertEmployee(){
  const name = document.getElementById('emp_name').value.trim();
  const code = document.getElementById('emp_code').value.trim();
  const wage = Number(document.getElementById('emp_wage').value||0);
  const commute = Number(document.getElementById('emp_commute').value||0);
  if(!name){ alert('氏名を入力'); return; }
  const id = document.getElementById('btnAdd').dataset.editId || ''; // 空なら新規
  const res = await postJSON(API_B+'?action=employee_upsert',{id,name,code,hourly_wage:wage,commute_fixed:commute});
  document.getElementById('empMsg').textContent = res.ok? '保存しました':'エラー：'+(res.error||'');
  document.getElementById('btnAdd').dataset.editId='';
  document.getElementById('emp_name').value=''; document.getElementById('emp_code').value=''; document.getElementById('emp_wage').value='';
  document.getElementById('emp_commute').value='0';
  loadEmployees();
}

async function loadRules(){
  const r = await getJSON(API_B+'?action=rules_get');
  const v = r.rules||{};
  document.getElementById('r_start').value = v.round_start||5;
  document.getElementById('r_end').value   = v.round_end||5;
  document.getElementById('r_worked').value= v.round_worked||1;
  document.getElementById('r_mode').value  = v.round_mode||'floor';
  document.getElementById('r_wage').value  = v.default_wage||1100;
}

async function saveRules(){
  const body = {
    round_start:Number(document.getElementById('r_start').value||5),
    round_end:Number(document.getElementById('r_end').value||5),
    round_worked:Number(document.getElementById('r_worked').value||1),
    round_mode:String(document.getElementById('r_mode').value||'floor'),
    default_wage:Number(document.getElementById('r_wage').value||1100)
  };
  const res = await postJSON(API_B+'?action=rules_save', body);
  document.getElementById('ruleMsg').textContent = res.ok? '保存しました':'エラー：'+(res.error||'');
}

function downloadCSV(){
  const m = document.getElementById('csvMonth').value; // YYYY-MM
  if(!m){ alert('対象月を選択'); return; }
  const url = API_B + '?action=report_csv&month=' + m;
  window.open(url, '_blank');
}

document.getElementById('btnAdd').onclick = upsertEmployee;
document.getElementById('btnReloadEmp').onclick = loadEmployees;
document.getElementById('btnSaveRules').onclick = saveRules;
document.getElementById('btnReloadRules').onclick = loadRules;
document.getElementById('btnCSV').onclick = downloadCSV;

(function init(){
  const now = new Date();
  document.getElementById('csvMonth').value = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  loadEmployees(); loadRules();
})();
</script>
</body>
</html>
