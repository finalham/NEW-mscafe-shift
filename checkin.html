<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mscafe SHIFT – 打刻</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body{margin:0;background:#faf6f1;color:#292929;font:14px/1.6 'Montserrat','Noto Sans JP',sans-serif}
  header{padding:14px 16px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0}
  h1{margin:0;font-size:18px;color:#6b4f4f}
  main{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.04)}
  label{display:block;font-size:12px;color:#7a6f69;margin:0 0 6px}
  input,select,button{width:100%;padding:12px;border:1px solid #e9ddd3;border-radius:10px;box-sizing:border-box;font-size:14px}
  button{background:#3e7a6b;color:#fff;border:none;cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  .muted{color:#7a6f69}
  .msg{margin-top:8px}
  .msg.error{color:#d93636}
  .msg.ok{color:#2f855a}
</style>
</head>
<body>
<header><h1>☕ Mscafe SHIFT – 打刻</h1></header>
<main>
  <div class="card">
    <div class="row">
      <div class="col"><label>従業員</label><select id="emp"></select></div>
      <div class="col"><label>開始</label><input type="datetime-local" id="start"></div>
      <div class="col"><label>休憩（分）</label><input type="number" id="brk" value="0" min="0" step="5"></div>
      <div class="col"><label>終了</label><input type="datetime-local" id="end"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="col"><button id="save">💾 保存</button></div>
      <div class="col"><button id="now" style="background:#fff;color:#3e7a6b;border:1px solid #3e7a6b">🕒 現在時刻</button></div>
    </div>
    <div id="msg" class="msg muted"></div>
  </div>
</main>
<script>
/* ←あなたのAPI(A) */
const API_BASE = 'https://script.google.com/macros/s/AKfycbwZj9yYSMNfbTLGyPRXwm73oK4GuMVbO1bvcVjnZlbIYT5Zg5J4deMP2gWXqimBp6Tg3g/exec';

function pad(n){return String(n).padStart(2,'0')}
function setNow(){
  const d=new Date(); const iso=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  document.getElementById('start').value=iso; document.getElementById('end').value=iso;
}
function showMsg(text, kind='muted'){
  const el=document.getElementById('msg');
  el.className='msg '+(kind==='error'?'error':(kind==='ok'?'ok':'muted'));
  el.textContent=text;
}
function loadEmployees(){
  return fetch(`${API_BASE}?action=employees`).then(r=>r.json()).then(j=>{
    const sel=document.getElementById('emp'); sel.innerHTML='';
    (j.employees||[]).filter(e=>e.active).forEach(e=>{
      const o=document.createElement('option'); o.value=e.id; o.textContent=e.name; sel.appendChild(o);
    });
  });
}
function save(){
  const empSel=document.getElementById('emp');
  const empId=empSel.value;
  if(!empId){ showMsg('従業員を選択してください','error'); return; }
  const empName=empSel.selectedOptions[0].textContent;

  const startStr=document.getElementById('start').value;
  const endStr  =document.getElementById('end').value;
  if(!startStr||!endStr){ showMsg('開始と終了を入力してください','error'); return; }

  // ▼▼ ここがバリデーション（終了 > 開始 必須）▼▼
  const startLocal = new Date(startStr);
  const endLocal   = new Date(endStr);
  if (isNaN(startLocal.getTime()) || isNaN(endLocal.getTime())){
    showMsg('日時の形式が正しくありません','error'); return;
  }
  if (endLocal.getTime() <= startLocal.getTime()){
    showMsg('退勤時間は開始時間より後にしてください','error'); return;
  }
  // ▲▲ ここまで ▲▲

  const brk=Number(document.getElementById('brk').value||0);
  const date = startStr.slice(0,10); // 翌日またぎ無し前提
  const payload={
    employee_id:empId,
    employee_name:empName,
    site:'HQ',
    date,
    startISO:startLocal.toISOString(),
    endISO:endLocal.toISOString(),
    break_min:brk,
    user_agent:navigator.userAgent
  };

  showMsg('送信中…');
  fetch(`${API_BASE}?action=shift`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok) throw new Error(res.error||'save failed');
    showMsg(`保存しました。実働 ${(res.worked_min/60).toFixed(2)} h / 日給 ${res.daily_pay.toLocaleString()} 円`,'ok');
  }).catch(err=>{
    showMsg(err.message||String(err),'error');
  });
}

(function init(){
  loadEmployees().then(setNow);
  document.getElementById('now').onclick=setNow;
  document.getElementById('save').onclick=save;
})();
</script>
</body>
</html>
