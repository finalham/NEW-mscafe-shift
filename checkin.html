<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mscafe SHIFT – 打刻</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body{margin:0;background:#faf6f1;color:#292929;font:14px/1.6 'Montserrat','Noto Sans JP',sans-serif}
  header{padding:14px 16px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0}
  h1{margin:0;font-size:18px;color:#6b4f4f}
  main{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.04)}
  label{display:block;font-size:12px;color:#7a6f69;margin:0 0 6px}
  input,select,button{width:100%;padding:12px;border:1px solid #e9ddd3;border-radius:10px;box-sizing:border-box;font-size:14px}
  button{background:#3e7a6b;color:#fff;border:none;cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 220px}
  .muted{color:#7a6f69}
  .error{color:#b91c1c;margin-top:8px;font-weight:600}
  .ok{color:#166534;margin-top:8px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #eee;padding:8px;text-align:center}
  th{background:#fafafa}
</style>
</head>
<body>
<header><h1>☕ Mscafe SHIFT – 打刻</h1></header>
<main>
  <div class="card">
    <div class="row">
      <div class="col"><label>従業員</label><select id="emp"></select></div>
      <div class="col"><label>休憩（分）</label><input type="number" id="brk" value="0" min="0" step="5"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><label>開始（日時）</label><input type="datetime-local" id="start"></div>
      <div class="col"><label>終了（日時）</label><input type="datetime-local" id="end"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><button id="now" style="background:#fff;color:#3e7a6b;border:1px solid #3e7a6b">🕒 現在時刻をセット</button></div>
      <div class="col"><button id="save">💾 保存</button></div>
    </div>

    <div id="err" class="error" style="display:none"></div>
    <div id="msg" class="ok" style="display:none"></div>

    <div class="muted" style="margin-top:10px">最近の入力</div>
    <table id="recent">
      <thead><tr><th>氏名</th><th>日付</th><th>出勤</th><th>退勤</th><th>休憩</th></tr></thead>
      <tbody id="recentBody"></tbody>
    </table>
  </div>
</main>
<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbz6qkC8T_a6mkQQ_wgaO85qjZl8aWUiamukBtpf-syC8xERgPrS10j3pHYN8B2DfP5B/exec';

const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');

function toLocalInputValue(d){ // Date -> 'YYYY-MM-DDTHH:MM'
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function setNow(){
  const d=new Date();
  $('start').value = toLocalInputValue(d);
  $('end').value   = toLocalInputValue(d);
}

async function loadEmployees(){
  const res = await fetch(`${API_BASE}?action=employees`);
  const j = await res.json();
  const sel = $('emp'); sel.innerHTML='';
  (j.employees||[]).filter(e=>e.active).forEach(e=>{
    const o=document.createElement('option'); o.value=e.id; o.textContent=e.name; sel.appendChild(o);
  });
}

function validateTimes(){
  const start = $('start').value, end = $('end').value;
  if (!start || !end) return {ok:false, msg:'開始と終了を入力してください'};
  const s = new Date(start), e = new Date(end);
  if (isNaN(+s) || isNaN(+e)) return {ok:false, msg:'日時の形式が不正です'};
  if (e <= s) return {ok:false, msg:'退勤時間は開始時間より後にしてください'};
  return {ok:true};
}

function showError(msg){
  $('err').textContent = msg; $('err').style.display='block';
  $('msg').style.display='none';
}
function showOk(msg){
  $('msg').textContent = msg; $('msg').style.display='block';
  $('err').style.display='none';
}

async function save(){
  const empSel = $('emp');
  const empId  = empSel.value;
  const empName= empSel.selectedOptions[0]?.textContent || '';
  const brk    = Number($('brk').value||0);

  const v = validateTimes();
  if (!v.ok){ showError(v.msg); return; }

  const start = $('start').value, end = $('end').value;
  const date  = start.slice(0,10); // 翌日またぎ無し前提

  const payload = {
    employee_id: empId,
    employee_name: empName,
    site: 'HQ',
    date,
    startISO: new Date(start).toISOString(),
    endISO:   new Date(end).toISOString(),
    break_min: brk,
    user_agent: navigator.userAgent
  };

  $('save').disabled = true;
  try{
    const res = await fetch(`${API_BASE}?action=shift`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if (!j.ok){
      // サーバ側のバリデーションメッセージを優先表示
      showError(j.message || j.error || '保存に失敗しました');
      return;
    }
    showOk(`保存しました。（実働 ${(j.worked_min/60).toFixed(2)} h / 日給 ${j.daily_pay.toLocaleString()} 円）`);
    appendRecent(empName, date, start.slice(11,16), end.slice(11,16), brk);
  }catch(err){
    showError(err.message||String(err));
  }finally{
    $('save').disabled = false;
  }
}

function appendRecent(name, ymd, s, e, brk){
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${name}</td><td>${ymd}</td><td>${s}</td><td>${e}</td><td>${brk}</td>`;
  $('recentBody').prepend(tr);
}

(async function init(){
  await loadEmployees(); setNow();
  $('now').onclick = setNow;
  $('save').onclick = save;

  // 入力のたびにクライアント側で即時チェック（赤文表示）
  ['start','end'].forEach(id=>{
    $(id).addEventListener('change', ()=>{
      const v = validateTimes();
      if (!v.ok) showError(v.msg); else {$('err').style.display='none';}
    });
  });
})();
</script>
</body>
</html>
