<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Mscafe SHIFT â€“ æ‰“åˆ»</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fff7f2;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--line:#efe7df;
    --brand:#0e9f6e;--brand-ink:#fff;--danger:#dc2626
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 "Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--line)}
  .wrap{max-width:640px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:10px}
  .brand{font-size:20px;font-weight:700;letter-spacing:.02em}
  main{max-width:640px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.05);padding:14px}
  label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
  select,input,button{width:100%;padding:14px 12px;border:1px solid var(--line);border-radius:12px;font:inherit;background:#fff}
  input[type="number"]{appearance:textfield} input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 240px}
  .btn{background:var(--brand);color:var(--brand-ink);border-color:var(--brand);font-weight:600}
  .btn-ghost{background:#fff;color:var(--brand);border-color:var(--brand)}
  .btn-sm{padding:10px 12px;border-radius:10px}
  .msg{margin-top:10px;font-size:14px}
  .msg.ok{color:#166534}.msg.err{color:var(--danger)}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-variant-numeric:tabular-nums}
  th,td{padding:10px;border-top:1px solid var(--line)}
  th{background:#fafafa;text-align:left}
  .help{color:var(--muted);font-size:13px}
  @media (min-width:700px){
    html,body{font-size:17px}
    .wrap{padding:14px 18px}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="font-size:24px">â˜•</div>
    <div class="brand">Mscafe SHIFT â€“ æ‰“åˆ»</div>
    <button id="btnNow" class="btn-ghost btn-sm" style="margin-left:auto;flex:0 0 auto">ğŸ•’ ç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</button>
  </div>
</header>

<main>
  <div class="card">
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <label>å¾“æ¥­å“¡</label>
        <select id="emp">
          <option value="" disabled selected>â€” èª­ã¿è¾¼ã¿ä¸­ â€¦ â€”</option>
        </select>
        <div class="help" id="empHelp"></div>
      </div>
      <div class="col" style="flex:0 0 120px">
        <button id="btnReloadEmp" class="btn-ghost btn-sm" title="å¾“æ¥­å“¡ã‚’èª­ã¿ç›´ã™">å†èª­ã¿è¾¼ã¿</button>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
        <input id="brk" type="number" min="0" step="5" value="0" inputmode="numeric"/>
      </div>
    </div>

    <label>é–‹å§‹ï¼ˆæ—¥æ™‚ï¼‰</label>
    <input id="start" type="datetime-local" autocomplete="off"/>

    <label>çµ‚äº†ï¼ˆæ—¥æ™‚ï¼‰</label>
    <input id="end" type="datetime-local" autocomplete="off"/>

    <div class="row" style="margin-top:12px">
      <div class="col"><button id="btnSave" class="btn">ğŸ’¾ ä¿å­˜</button></div>
    </div>
    <div id="msg" class="msg"></div>
  </div>

  <div class="card" style="margin-top:14px">
    <b>æœ€è¿‘ã®å…¥åŠ›ï¼ˆåŒæ—¥ãŒã‚ã‚Œã°ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰</b>
    <table>
      <thead><tr><th>æ°å</th><th>æ—¥ä»˜</th><th>å‡ºå‹¤</th><th>é€€å‹¤</th><th>ä¼‘æ†©</th></tr></thead>
      <tbody id="hist"><tr><td colspan="5" class="help">â€” ã¾ã ã‚ã‚Šã¾ã›ã‚“ â€”</td></tr></tbody>
    </table>
  </div>
</main>

<script>
/* === è¨­å®šï¼ˆã‚ãªãŸã®Aã®URLï¼‰ === */
const API_BASE = 'https://script.google.com/macros/s/AKfycbwZj9yYSMNfbTLGyPRXwm73oK4GuMVbO1bvcVjnZlbIYT5Zg5J4deMP2gWXqimBp6Tg3g/exec';

/* === ä¾¿åˆ©é–¢æ•° === */
const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');
const toLocalInputValue = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
function showMsg(text, ok=false){ const el=$('msg'); el.textContent=text; el.className='msg '+(ok?'ok':'err'); }

/* === ç¾åœ¨æ™‚åˆ»ã‚»ãƒƒãƒˆ === */
function setNow(){
  const d = new Date();
  const v = toLocalInputValue(d);
  $('start').value = v;
  $('end').value   = v;
}

/* === å¾“æ¥­å“¡ãƒ­ãƒ¼ãƒ‰ï¼ˆå¤±æ•—åŸå› ã‚‚è¡¨ç¤ºï¼‰ === */
async function loadEmployees(){
  const sel = $('emp');
  const help = $('empHelp');
  sel.innerHTML = `<option value="" disabled selected>â€” èª­ã¿è¾¼ã¿ä¸­ â€¦ â€”</option>`;
  help.textContent = '';
  try{
    const url = `${API_BASE}?action=employees&_=${Date.now()}`; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
    const res = await fetch(url, {method:'GET', mode:'cors', headers:{'Accept':'application/json'}});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    const list = (j && j.employees) ? j.employees.filter(e=>e.active) : [];
    sel.innerHTML = '';
    if(list.length===0){
      sel.innerHTML = `<option value="" disabled selected>â€” å¾“æ¥­å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ â€”</option>`;
      help.textContent = 'Employees ã‚·ãƒ¼ãƒˆã« idãƒ»nameãƒ»active=TRUE ã®è¡ŒãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      return;
    }
    sel.appendChild(new Option('â€” é¸æŠã—ã¦ãã ã•ã„ â€”','',true,true));
    sel.options[0].disabled = true;
    list.forEach(e=> sel.appendChild(new Option(e.name, e.id)));
  }catch(err){
    sel.innerHTML = `<option value="" disabled selected>â€” å–å¾—ã§ãã¾ã›ã‚“ â€”</option>`;
    help.innerHTML = `èª­ã¿è¾¼ã¿å¤±æ•—ï¼š${(err && err.message)||err}ã€‚<br>ãƒ»Aã®URLãŒæ­£ã—ã„ã‹<br>ãƒ»Aã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ›´æ–°æ¸ˆã¿ã‹<br>ãƒ»CORSè¨±å¯ï¼ˆã‚³ãƒ¼ãƒ‰æ¸ˆï¼‰ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
  }
}

/* === å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé€€å‹¤>å‡ºå‹¤ï¼‰ === */
function validateTimes(){
  const sVal = $('start').value, eVal = $('end').value;
  if(!sVal || !eVal) return {ok:false, msg:'é–‹å§‹ã¨çµ‚äº†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'};
  const s = new Date(sVal), e = new Date(eVal);
  if(isNaN(s) || isNaN(e)) return {ok:false, msg:'æ—¥æ™‚ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'};
  if(e <= s) return {ok:false, msg:'é€€å‹¤æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„'};
  return {ok:true, s, e};
}

/* === ä¿å­˜ === */
async function save(){
  const empSel = $('emp');
  const empId = empSel.value;
  if(!empId){ showMsg('å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const empName = empSel.selectedOptions[0].textContent;

  const v = validateTimes();
  if(!v.ok){ showMsg(v.msg); return; }

  const brk = Number($('brk').value || 0);
  const date = $('start').value.slice(0,10);
  const payload = {
    employee_id: empId,
    employee_name: empName,
    site: 'HQ',
    date,
    startISO: new Date($('start').value).toISOString(),
    endISO:   new Date($('end').value).toISOString(),
    break_min: brk,
    user_agent: navigator.userAgent
  };

  try{
    // iOS/Safariã®ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆå›é¿ï¼štext/plain ã§é€ã‚‹
    const res = await fetch(`${API_BASE}?action=shift`, {
      method:'POST',
      mode:'cors',
      headers:{'Content-Type':'text/plain;charset=utf-8','Accept':'application/json'},
      body: JSON.stringify(payload)
    });
    // å¤±æ•—æ™‚ã« HTML ãŒè¿”ã‚‹ã¨ JSON ã§è½ã¡ã‚‹ â†’ æ˜ç¤ºãƒã‚§ãƒƒã‚¯
    const text = await res.text();
    let j;
    try{ j = JSON.parse(text); }catch{ throw new Error('ã‚µãƒ¼ãƒã‹ã‚‰JSONä»¥å¤–ãŒè¿”ã‚Šã¾ã—ãŸ'); }
    if(!j.ok) throw new Error(j.error||'save failed');

    showMsg(`ä¿å­˜ã—ã¾ã—ãŸã€‚å®Ÿåƒ ${(j.worked_min/60).toFixed(2)} h / æ—¥çµ¦ ${j.daily_pay.toLocaleString()} å††`, true);
    addHistoryRow(empName, date, $('start').value.slice(11,16), $('end').value.slice(11,16), brk);
  }catch(err){
    showMsg('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (err.message||err));
  }
}

/* === æœ€è¿‘ã®å…¥åŠ› è¡¨ç¤º === */
function addHistoryRow(name, date, s, e, brk){
  const tb = $('hist');
  if(tb.children.length===1 && tb.children[0].tagName==='TR' && tb.children[0].children.length===1){ tb.innerHTML=''; }
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${name}</td><td>${date}</td><td>${s}</td><td>${e}</td><td>${brk}</td>`;
  tb.prepend(tr);
}

/* === åˆæœŸåŒ– === */
document.addEventListener('DOMContentLoaded', async ()=>{
  $('btnNow').addEventListener('click', setNow);
  $('btnReloadEmp').addEventListener('click', loadEmployees);
  $('btnSave').addEventListener('click', save);
  await loadEmployees();
  setNow();
});
</script>
</body>
</html>
